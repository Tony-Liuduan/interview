
# pm2å¼€å¯å¤šè¿›ç¨‹å¼•å‘çš„nodeå¤šè¿›ç¨‹æ¨¡å‹æ€è€ƒ
> æŠ„ä½œä¸šæ¥è‡ªï¼šhttps://juejin.im/post/5d43017be51d4561f40adcf9#heading-25
> ps:åˆå­¦è€…ï¼Œæœ‰é”™è¯¯è¯·å¤§ä½¬ç»™äºˆæŒ‡æ­£

## è¿›ç¨‹ & çº¿ç¨‹ & åæˆ

### è¿›ç¨‹ï¼š
1. nodejså…¨å±€å˜é‡-processï¼ŒNode.js é‡Œé€šè¿‡ node app.js å¼€å¯ä¸€ä¸ªæœåŠ¡è¿›ç¨‹
2. è¿›ç¨‹æ˜¯è´Ÿè´£ç®¡ç†çº¿ç¨‹çš„
3. è¿›ç¨‹é€šè¿‡æ“ä½œç³»ç»Ÿè°ƒåº¦åˆ†é…cpuæ ¸å¿ƒå†…å­˜èµ„æº
4. æ¯ä¸ªè¿›ç¨‹éƒ½æ‹¥æœ‰è‡ªå·±çš„ç‹¬ç«‹ç©ºé—´åœ°å€ã€æ•°æ®æ ˆ
5. è¿›ç¨‹ä¹‹é—´ä¸å…±äº«å†…å­˜ï¼Œä¸€ä¸ªè¿›ç¨‹æ— æ³•è®¿é—®å¦å¤–ä¸€ä¸ªè¿›ç¨‹é‡Œå®šä¹‰çš„å˜é‡ã€æ•°æ®ç»“æ„ï¼Œåªæœ‰å»ºç«‹äº† IPC é€šä¿¡ï¼Œè¿›ç¨‹ä¹‹é—´æ‰å¯æ•°æ®å…±äº«

### çº¿ç¨‹ï¼š
1. çº¿ç¨‹æ˜¯éš¶å±äºè¿›ç¨‹çš„ï¼Œè¢«åŒ…å«äºè¿›ç¨‹ä¹‹ä¸­
2. ä¸€ä¸ªçº¿ç¨‹åªèƒ½éš¶å±äºä¸€ä¸ªè¿›ç¨‹ï¼Œä½†æ˜¯ä¸€ä¸ªè¿›ç¨‹æ˜¯å¯ä»¥æ‹¥æœ‰å¤šä¸ªçº¿ç¨‹çš„
3. çº¿ç¨‹ä¹‹é—´å…±äº«å½“å‰è¿›ç¨‹çš„å†…å­˜cpuèµ„æºï¼Œå¯ä»¥äº¤äº’

### åç¨‹ï¼š**æ˜¯ä¸ªä»€ä¹ˆé¬¼ï¼Œè¿˜ä¸çŸ¥é“ï¼Ÿï¼Ÿï¼Ÿç»å¸¸å¬è¯´**


### å¤šè¿›ç¨‹å•çº¿ç¨‹ vs å•è¿›ç¨‹å¤šçº¿ç¨‹

#### å¤šè¿›ç¨‹å•çº¿ç¨‹
1. è¿›ç¨‹ç®¡ç†ï¼šï¼ˆä»£ç  | æ•°æ® | æ–‡ä»¶å¥æŸ„ï¼‰ & ï¼ˆå¯„å­˜å™¨ | æ ˆï¼‰
2. å•çº¿ç¨‹ç®¡ç†ï¼š~
3. è¿›ç¨‹ä¹‹å‰ç»´æŠ¤ç›¸åŒçš„ï¼ˆä»£ç  | æ•°æ® | æ–‡ä»¶å¥æŸ„ï¼‰
4. è¿›ç¨‹é—´æ²Ÿé€šä¸ä¾¿

#### å•è¿›ç¨‹å¤šçº¿ç¨‹
1. è¿›ç¨‹ç®¡ç†ï¼šï¼ˆä»£ç  | æ•°æ® | æ–‡ä»¶å¥æŸ„ï¼‰ 
2. å„çº¿ç¨‹ç®¡ç†ï¼šï¼ˆå¯„å­˜å™¨ | æ ˆï¼‰
3. çº¿ç¨‹ä¹‹é—´å…±äº«ä»£ç æ•°æ®æ–‡ä»¶å¥æŸ„ï¼Œæ–¹ä¾¿äº¤äº’

---


## nodeå¼€å¯å¤šè¿›ç¨‹æ–¹å¼
1. child_process æ¨¡å—
2. cluster æ¨¡å—

### ä¸¤è€…å…±åŒç‚¹
1. æ— è®ºæ˜¯ child_process æ¨¡å—è¿˜æ˜¯ cluster æ¨¡å—ï¼Œéƒ½æ˜¯ä¸ºäº†è§£å†³ Nodejs å®ä¾‹å•çº¿ç¨‹è¿è¡Œæ— æ³•åˆ©ç”¨å¤šæ ¸ CPU çš„é—®é¢˜è€Œå‡ºç°çš„
2. éƒ½æ˜¯ä½¿ç”¨forkæ–¹æ³•å‡ºç‹¬ç«‹çš„å­è¿›ç¨‹
3. é€šä¿¡ï¼šé€šè¿‡sendå‘é€æ¶ˆæ¯ï¼Œmessageæ¥æ”¶æ¶ˆæ¯


### child_process
1. child_process.spawn()ï¼š
    - **ç»†èŠ‚å¾…è¡¥å……ï¼Œæ²¡æœ‰å®é™…åº”ç”¨è¿‡**
    - é€‚ç”¨äºè¿”å›å¤§é‡æ•°æ®ï¼Œä¾‹å¦‚å›¾åƒå¤„ç†ï¼ŒäºŒè¿›åˆ¶æ•°æ®å¤„ç†ã€‚
    - çœ‹åˆ°earth-scripté¡¹ç›®æœ‰ç”¨ cross-spawn ç¬¬ä¸‰åº“
    
    ```js
    const spawn = require('child_process').spawn;
 
    spawn('npm', {
        stdio: 'inherit'
    });
    ```
2. child_process.exec()ï¼š
    - é€‚ç”¨äºå°é‡æ•°æ®ï¼ŒmaxBuffer é»˜è®¤å€¼ä¸º 200 * 1024 è¶…å‡ºè¿™ä¸ªé»˜è®¤å€¼å°†ä¼šå¯¼è‡´ç¨‹åºå´©æºƒï¼Œæ•°æ®é‡è¿‡å¤§å¯é‡‡ç”¨ spawnã€‚
    - çœ‹é¡¹ç›®ä¸­å¤šç”¨äºshellå‘½ä»¤
    - node-moniteré¡¹ç›®æœ‰ä½¿ç”¨
3. child_process.execFile()ï¼š
    - **ç»†èŠ‚å¾…è¡¥å……ï¼Œæ²¡æœ‰å®é™…åº”ç”¨è¿‡**
    - ç±»ä¼¼ child_process.exec()ï¼ŒåŒºåˆ«æ˜¯ä¸èƒ½é€šè¿‡ shell æ¥æ‰§è¡Œï¼Œä¸æ”¯æŒåƒ I/O é‡å®šå‘å’Œæ–‡ä»¶æŸ¥æ‰¾è¿™æ ·çš„è¡Œä¸º
4. child_process.fork()ï¼š
    - è¡ç”Ÿæ–°çš„è¿›ç¨‹ï¼Œè¿›ç¨‹ä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ V8 å®ä¾‹ã€å†…å­˜ï¼Œç³»ç»Ÿèµ„æºæ˜¯æœ‰é™çš„ï¼Œä¸å»ºè®®è¡ç”Ÿå¤ªå¤šçš„å­è¿›ç¨‹å‡ºæ¥ï¼Œé€šé•¿æ ¹æ®ç³»ç»Ÿ** CPU æ ¸å¿ƒæ•°**è®¾ç½®ã€‚

    ```js
    /* æŠ„è¢­è‡ªnode-moniteré¡¹ç›® */
    const cp = require('child_process');
    async function asyncExec(command){
        return new Promise((reslove,reject) => {
            cp.exec(command,function(error,stdout,  stderr){
                if(error){
                    reject(error);
                    return;
                }
                reslove(stdout);
            });
        });
    }

    module.exports = asyncExec;

    // è°ƒç”¨
    await asyncExec('cd ' + base_path + '&& ' + tarCmd + ' ./')
    await asyncExec(`tail -n ${lines} ${absolutePath}`);
    ```

### cluster
1. clusteræ ¸å¿ƒæ€æƒ³
    * clusteræ¨¡å—é‡‡ç”¨çš„æ˜¯ç»å…¸çš„ä¸»ä»æ¨¡å‹ï¼Œ
    * clusterä¼šåˆ›å»ºä¸€ä¸ªmasterè¿›ç¨‹ï¼Œç„¶åmasterè¿›ç¨‹æ ¹æ®ä½ æŒ‡å®šçš„æ•°é‡ï¼ˆä¸€èˆ¬æ˜¯æœåŠ¡å™¨cpuæ ¸å¿ƒæ•°ï¼‰å¤åˆ¶å‡ºå¤šä¸ªå­è¿›ç¨‹ï¼Œ
    * ç”±masterè¿›ç¨‹æ¥ç®¡ç†æ‰€æœ‰çš„å­è¿›ç¨‹ï¼Œ
    * ä¸»è¿›ç¨‹ä¸è´Ÿè´£å…·ä½“çš„ä»»åŠ¡å¤„ç†ï¼Œä¸»è¦å·¥ä½œæ˜¯è´Ÿè´£è°ƒåº¦å’Œç®¡ç†ã€‚


2. clusterä¼˜ç‚¹ï¼š
    * è´Ÿè½½å‡è¡¡: 
        - clusteræ¨¡å—ä½¿ç”¨å†…ç½®çš„æ¥æ›´å¥½åœ°å¤„ç†çº¿ç¨‹ä¹‹é—´çš„å‹åŠ›ï¼Œè¯¥è´Ÿè½½å‡è¡¡ä½¿ç”¨äº†Round-robinç®—æ³•ï¼ˆä¹Ÿè¢«ç§°ä¹‹ä¸ºå¾ªç¯ç®—æ³•ï¼‰
        - clusterä½¿ç”¨Round-robinè°ƒåº¦ç­–ç•¥æ—¶ï¼Œmasteræ¥æ”¶æ‰€æœ‰ä¼ å…¥çš„è¿æ¥è¯·æ±‚ï¼Œç„¶åå°†ç›¸åº”çš„TCPè¯·æ±‚å¤„ç†å‘é€ç»™é€‰ä¸­çš„å·¥ä½œè¿›ç¨‹ï¼ˆè¯¥æ–¹å¼ä»ç„¶é€šè¿‡IPCæ¥è¿›è¡Œé€šä¿¡ï¼‰ã€‚
    * ä¸€ä¸ªTCPæœåŠ¡å™¨
        - clu steråªä¼šåœ¨masterè¿›ç¨‹å†…éƒ¨å¯åŠ¨ä¸€ä¸ªTCPæœåŠ¡å™¨ï¼Œè€ŒçœŸæ­£ç›‘å¬ç«¯å£çš„åªæœ‰è¿™ä¸ªæœåŠ¡å™¨ï¼Œ
        - å½“æ¥è‡ªå‰ç«¯çš„è¯·æ±‚è§¦å‘æœåŠ¡å™¨çš„connectionäº‹ä»¶åï¼Œmasterä¼šå°†å¯¹åº”çš„socketå¥æŸ„å‘é€ç»™å­è¿›ç¨‹
        - åœ¨Unix / Linuxç³»ç»Ÿä¸‹ï¼Œä¸€ä¸ª**socketå¥æŸ„**ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œåœ¨socketä¸Šæ”¶é“å‘æ•°æ®å†…ï¼Œç›¸å½“äºå¯¹ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œè¯»å†™ï¼Œæ‰€ä»¥ä¸€ä¸ªsocketå¥æŸ„ï¼Œé€šå¸¸ä¹Ÿç”¨è¡¨å®¹ç¤ºæ–‡ä»¶å¥æŸ„çš„fdæ¥è¡¨ç¤ºï¼ˆ**ğŸ˜­ï¼Ÿï¼Ÿä»€ä¹ˆé¬¼ï¼Œå¸Œæœ›æ‰¾åˆ°è¯´äººè¯çš„ç¿»è¯‘**ï¼‰

3. clusterç¼ºç‚¹ï¼š
    * cluster åªèƒ½ç®¡ç†ä¸€ç»„**ç›¸åŒ**å­è¿›ç¨‹, ä¸èƒ½åƒchild_processå¯ä»¥forkå‡ºå¤šç»„è¿›ç¨‹


## IPC(nter-Process Communication) è¿›ç¨‹é—´é€šä¿¡ 
> **çœ‹ä¸æ‡‚ï¼Œlibuvå¤ªåº•å±‚ï¼Œæš‚ä¸”å‡è£…ä¼šäº†**

Nodeä¸­å®ç°IPCé€šé“æ˜¯ä¾èµ–äºlibuv
windowsä¸‹ç”±å‘½åç®¡é“(name pipe)å®ç°ï¼Œlinuxç³»ç»Ÿåˆ™é‡‡ç”¨Unix Domain Socketå®ç°
è¡¨ç°åœ¨åº”ç”¨å±‚ä¸Šçš„è¿›ç¨‹é—´é€šä¿¡åªæœ‰ç®€å•çš„messageäº‹ä»¶å’Œsend()æ–¹æ³•ï¼Œæ¥å£ååˆ†ç®€æ´å’Œæ¶ˆæ¯åŒ–ã€‚

## æŸ¥çœ‹nodeè¿›ç¨‹pid
```sh
# USER   PID  %CPU %MEM      VSZ    RSS   TT  STAT STARTED      TIME COMMAND
ps aux | grep node

# UID   PID  PPID   C STIME   TTY           TIME CMD
# èƒ½æŸ¥çœ‹çˆ¶è¿›ç¨‹id
ps -ef | grep node

# æŸ¥æ‰¾åƒµæ­»è¿›ç¨‹
ps -A -o stat,ppid,pid | grep -e '^[Zz]'
#å‘½ä»¤æ³¨è§£ï¼š
#-A å‚æ•°åˆ—å‡ºæ‰€æœ‰è¿›ç¨‹
#-o è‡ªå®šä¹‰è¾“å‡ºå­—æ®µ æˆ‘ä»¬è®¾å®šæ˜¾ç¤ºå­—æ®µä¸º statï¼ˆçŠ¶æ€ï¼‰, ppidï¼ˆè¿›ç¨‹çˆ¶idï¼‰, pid(è¿›ç¨‹id)ï¼Œcmdï¼ˆå‘½ä»¤ï¼‰è¿™å››ä¸ªå‚æ•°


# ä¸€é”®æ€æ­»åƒµæ­»è¿›ç¨‹
# https://www.cnblogs.com/reality-soul/p/6343339.html
ps -A -o stat,ppid,pid,cmd | grep -e '^[Zz]' | awk '{print $2}' | xargs kill -9
```

## æ€è¿›ç¨‹
```sh
# ä¸€èˆ¬æ€è¿›ç¨‹
kill pid
# å±é™©æ€è¿›ç¨‹ï¼š-9 è¡¨ç¤ºå¼ºè¿«è¿›ç¨‹ç«‹å³åœæ­¢
kill -9 pid
# æ€æ­»åŒä¸€è¿›ç¨‹ç»„å†…çš„æ‰€æœ‰è¿›ç¨‹ã€‚å…¶å…è®¸æŒ‡å®šè¦ç»ˆæ­¢çš„è¿›ç¨‹çš„åç§°ï¼Œè€ŒéPIDã€‚
killall nginx
```

### kill -9 çš„å¯æ€•ä¹‹å¤„ï¼Œæ…ç”¨
> é˜²æ­¢åƒµå°¸è¿›ç¨‹è¢«initå›æ”¶ï¼Œæ— æ³•é‡Šæ”¾ï¼Œé•¿ä¹…å ç”¨èµ„æºï¼Œåªèƒ½é€šè¿‡é‡å¯æœåŠ¡å™¨æ¥è§£å†³
è¿™ä¸ªå¼ºå¤§å’Œå±é™©çš„å‘½ä»¤è¿«ä½¿è¿›ç¨‹åœ¨è¿è¡Œæ—¶çªç„¶ç»ˆæ­¢ï¼Œè¿›ç¨‹åœ¨ç»“æŸåä¸èƒ½è‡ªæˆ‘æ¸…ç†ã€‚
å±å®³æ˜¯å¯¼è‡´ç³»ç»Ÿèµ„æºæ— æ³•æ­£å¸¸é‡Šæ”¾ï¼Œä¸€èˆ¬ä¸æ¨èä½¿ç”¨ï¼Œé™¤éå…¶ä»–åŠæ³•éƒ½æ— æ•ˆã€‚
å½“ä½¿ç”¨æ­¤å‘½ä»¤æ—¶ï¼Œä¸€å®šè¦é€šè¿‡`ps -A -o stat,ppid,pid | grep -e '^[Zz]'`ç¡®è®¤æ²¡æœ‰å‰©ä¸‹ä»»ä½•åƒµå°¸è¿›ç¨‹`zombie`ã€‚
åªèƒ½é€šè¿‡ç»ˆæ­¢çˆ¶è¿›ç¨‹ppidå‘½ä»¤`ps -A -o stat,ppid,pid,cmd | grep -e '^[Zz]' | awk '{print $2}' | xargs kill -9`æ¥æ¶ˆé™¤åƒµå°¸è¿›ç¨‹ã€‚å¦‚æœåƒµå°¸è¿›ç¨‹è¢«`init`æ”¶å…»ï¼Œé—®é¢˜å°±æ¯”è¾ƒä¸¥é‡äº†ã€‚
æ€æ­»`init`è¿›ç¨‹æ„å‘³ç€å…³é—­ç³»ç»Ÿã€‚
å¦‚æœç³»ç»Ÿä¸­æœ‰åƒµå°¸è¿›ç¨‹ï¼Œå¹¶ä¸”å…¶çˆ¶è¿›ç¨‹`ppid`æ˜¯`init`ï¼Œ
è€Œä¸”åƒµå°¸è¿›ç¨‹å ç”¨äº†å¤§é‡çš„ç³»ç»Ÿèµ„æºï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨æŸä¸ªæ—¶å€™**é‡å¯æœºå™¨**ä»¥æ¸…é™¤è¿›ç¨‹è¡¨äº†ã€‚


---

## å°demo

### fork
```js
/* index.js */
const http = require('http');
const fork = require('child_process').fork;


const server = http.createServer((req, res) => {
    if (req.url === '/test') {
        const worker = fork('./worker.js')
        worker.send('å¼€å¯ä¸€ä¸ªæ–°çš„å­è¿›ç¨‹');

        // å½“ä¸€ä¸ªå­è¿›ç¨‹ä½¿ç”¨ process.send() å‘é€æ¶ˆæ¯æ—¶ä¼šè§¦å‘ 'message' äº‹ä»¶
        worker.on('message', sum => {
            res.end(`Sum is ${sum}`);
            worker.kill();
        });

        // å­è¿›ç¨‹ç›‘å¬åˆ°ä¸€äº›é”™è¯¯æ¶ˆæ¯é€€å‡º
        worker.on('close', (code, signal) => {
            console.log(`æ”¶åˆ°closeäº‹ä»¶ï¼Œå­è¿›ç¨‹æ”¶åˆ°ä¿¡å· ${signal} è€Œç»ˆæ­¢ï¼Œé€€å‡ºç  ${code}`);
            worker.kill();
        });
    } else {
        res.end('hello word')
    }
});

server.listen(8001, () => {
    console.log(process.pid);
})



/* worker.js */
const computation = () => {
    let sum = 0;
    console.info('è®¡ç®—å¼€å§‹');
    console.time('è®¡ç®—è€—æ—¶');

    for (let i = 0; i < 1e10; i++) {
        sum += i
    };

    console.info('è®¡ç®—ç»“æŸ');
    console.timeEnd('è®¡ç®—è€—æ—¶');
    return sum;
};

process.on('message', msg => {
    console.log(msg, 'process.pid', process.pid); // å­è¿›ç¨‹id
    const sum = computation();

    // å¦‚æœNode.jsè¿›ç¨‹æ˜¯é€šè¿‡è¿›ç¨‹é—´é€šä¿¡äº§ç”Ÿçš„ï¼Œé‚£ä¹ˆï¼Œprocess.send()æ–¹æ³•å¯ä»¥ç”¨æ¥ç»™çˆ¶è¿›ç¨‹å‘é€æ¶ˆæ¯
    process.send(sum);
})


// fork æ¨¡å¼å¯åŠ¨å­è¿›ç¨‹ä¸èƒ½å…±äº«ç«¯å£ï¼ŒError: listen EADDRINUSE: address already in use :::8001
// const http = require('http');
// http
//     .createServer((req, res) => {
//         res.end('hello word');
//     })
//     .listen(8001)
```


### <font color='red'>cluster (pm2æ ¸å¿ƒ)</font>
```js
/* cluster.js */
const cpus = require('os').cpus().length;
const cluster = require('cluster');

// 1. clusteræ¨¡å—é‡‡ç”¨çš„æ˜¯ç»å…¸çš„ä¸»ä»æ¨¡å‹ï¼Œ
// 2. clusterä¼šåˆ›å»ºä¸€ä¸ªmasterï¼Œç„¶åæ ¹æ®ä½ æŒ‡å®šçš„æ•°é‡å¤åˆ¶å‡ºå¤šä¸ªå­è¿›ç¨‹ï¼Œ
// 3. ç”±masterè¿›ç¨‹æ¥ç®¡ç†æ‰€æœ‰çš„å­è¿›ç¨‹ï¼Œ
// 4. ä¸»è¿›ç¨‹ä¸è´Ÿè´£å…·ä½“çš„ä»»åŠ¡å¤„ç†ï¼Œä¸»è¦å·¥ä½œæ˜¯è´Ÿè´£è°ƒåº¦å’Œç®¡ç†ã€‚
if (cluster.isMaster) { // ä¸»è¿›ç¨‹, å¯ä»¥ä½¿ç”¨cluster.isMasterå±æ€§åˆ¤æ–­å½“å‰è¿›ç¨‹æ˜¯masterè¿˜æ˜¯worker(å·¥ä½œè¿›ç¨‹)ã€‚
    for (let i = 0; i < cpus; i++) {
        // fork å‡ºæœåŠ¡å™¨æ ¸å¿ƒæ•°é‡å­è¿›ç¨‹ï¼Œ 
        // clusteræ¨¡å—è°ƒç”¨forkæ–¹æ³•æ¥åˆ›å»ºå­è¿›ç¨‹ï¼Œè¯¥æ–¹æ³•ä¸child_processä¸­çš„forkæ˜¯åŒä¸€ä¸ªæ–¹æ³•ã€‚
        cluster.fork();
    }
    cluster.on('exit', function (worker, code, signal) {
        console.log('worker process died,id', worker.process.pid)
    })
} else {
    // Workerå¯ä»¥å…±äº«åŒä¸€ä¸ªTCPè¿æ¥, ä¸»è¿›ç¨‹åˆ›å»ºTCPè¿æ¥ï¼Œå½“æœ‰è¯·æ±‚è¿›æ¥ï¼Œä¼šæŠŠè¯·æ±‚çš„socketå¥æŸ„å‘é€ç»™å­è¿›ç¨‹ï¼Œå®ç°è´Ÿè½½å‡è¡¡
    require('./app.js');
}


/* app.js */
const http = require('http');
http
    .createServer((req, res) => {
        res.end('hello word');
    })
    .listen(9000)
```



---

# libuv

## libuvçš„çº¿ç¨‹æ± å®ç°å¤šçº¿ç¨‹
è§ä¸‹æœŸåˆ†æ™“ï¼Œç›®å‰çœ‹ä¸æ‡‚...

## node-eventloop
æŒç»­æ›´æ–°ä¸­...