# TCP
> 转载自 https://juejin.im/post/5e527c58e51d4526c654bf41

## TCP/IP 协议栈

### 5层
1. 应用层（http | ftp）提供应用比如浏览器支持
2. 传输层（tcp | udp）解决发送接收数据问题，保证数据传输的可靠性，防止丢包（如果丢包会重新排列发送）
    - 发起新的连接 SYN指令 seq = x
    - 服务器打开一个端口监听等待请求，收到请求后，返回确认应答 （ACK=x+1 & SYN指令 seq=y）
    - 客户端处于半连接状态，收到响应后应答 ACK=y+1 
    

    - 进入ESTABLISHED全连接状态发送数据
        * 会把一段数据分解成一段段更小的字节流发送，保证可靠性
        * 通过seq作为标记，在接收端根据seq组合被分解的包
        * 如果有seq不是连续的就判断为丢包，需要重新发送这个中断丢的包
    

    - 客户端请求关闭连接 FIN指令 seq=x+2
    - 服务端应答 ACK=x+3 处理剩余没处理完的包，并且关闭
    - 服务端再次发送关闭确认 FIN seq=y+1
    - 客户端应答 ACK=y+2
    - 服务端进入关闭CLOSE状态
    - 客户端开始在TIME-WAIT阶段等待2MSL
3. 网络层（ip）解决端到端的问题，ping命令就在这，A服务器请求从以太网到ppp连接再到以太网到B服务器
    - 子网掩码（来帮助区分网络号、主机号，标识以太网中ip数量）
4. 数据链路层(网络接口层) 以太网是使用网卡mac地址，ppp连接不使用mac地址，仅仅使用ip地址，将二进制编码编程网络中的帧
5. 物理层(网络接口层) 方式有wifi、网线(5v-0v曼彻斯特编码) 、光纤，这一步是将信息进行二进制编码


### 7层 OSI http3遵循7层协议结构
1. 应用层（http | ftp）提供应用比如浏览器支持
2. 表示层
3. 会话层
4. 传输层（tcp | udp）解决发送接收数据问题
5. 网络层（ip）解决端到端的问题，ping命令就在这
6. 数据链路层(网络接口层) 网卡mac地址
7. 物理层(网络接口层) wifi


### TCP 为何建立连接时一起传输，释放连接时却要分开传输？

建立连接时，被动方服务器端结束CLOSED阶段进入“握手”阶段并不需要任何准备，可以直接返回SYN和ACK报文，开始建立连接。
释放连接时，被动方服务器，突然收到主动方客户端释放连接的请求时并不能立即释放连接，因为还有必要的数据需要处理，所以服务器先返回ACK确认收到报文，经过CLOSE-WAIT阶段准备好释放连接之后，才能返回FIN释放连接报文。

所以是“三次握手”，“四次挥手”。


### 为什么客户端在TIME-WAIT阶段要等2MSL?
当客户端发出最后的ACK确认报文时，并不能确定服务器端能够收到该段报文。所以客户端在发送完ACK确认报文之后，会设置一个时长为2MSL的计时器。MSL指的是Maximum Segment Lifetime：一段TCP报文在传输过程中的最大生命周期。2MSL即是服务器端发出为FIN报文和客户端发出的ACK确认报文所能保持有效的最大时长。
服务器端在1MSL内没有收到客户端发出的ACK确认报文，就会再次向客户端发出FIN报文；


TCP是一个面向连接的、可靠的、基于字节流的传输层协议。
而UDP是一个面向无连接的传输层协议。(就这么简单，其它TCP的特性也就没有了)。
具体来分析，和 UDP 相比，TCP 有三大核心特性:


面向连接。所谓的连接，指的是客户端和服务器的连接，在双方互相通信之前，TCP 需要三次握手建立连接，而 UDP 没有相应建立连接的过程。


可靠性。TCP 花了非常多的功夫保证连接的可靠，这个可靠性体现在哪些方面呢？一个是有状态，另一个是可控制。


## TCP/UDP 区别
1. TCP是一个面向连接的、可靠的、基于字节流的传输层协议。

2. 而UDP是一个面向无连接的传输层协议。(就这么简单，其它TCP的特性也就没有了)。

TCP类似打电话，交代一件事必须有响应
UPD类似发电报、广播，交代没有响应


## DOS攻击
客户端发起大量连接请求服务器，并改写socket api，使客户端收到服务器ACK响应后，不再应答服务器，让服务器一直处于半连接状态，直到超时服务器才能主动关闭，造成服务器内存一直占用直到溢出服务挂掉